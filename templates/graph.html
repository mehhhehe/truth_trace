<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Propagation Graph â€“ {{ news_id }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='d3.v7.min.js') }}"></script>
</head>
<body>
    <div class="header">
        <h1>Propagation Graph: {{ news_id }}</h1>
        <p>Interactive cascade visualisation</p>
    </div>
    <div class="content">
        <div id="graph" class="graph-container"></div>
    </div>
    <script>
      const graphData = {{ graph_data | tojson | safe }};
      // Draw the graph on load
      drawGraph(graphData);
      function drawGraph(graphData) {
        const container = document.getElementById('graph');
        const width = container.clientWidth;
        const height = container.clientHeight;
        const svg = d3.select(container).append('svg')
          .attr('width', width)
          .attr('height', height);
        const nodes = graphData.nodes.map(id => ({ id: id }));
        const links = graphData.edges.map(e => ({ source: e[0], target: e[1] }));
        const degreeMap = {};
        nodes.forEach(n => { degreeMap[n.id] = 0; });
        links.forEach(l => {
          degreeMap[l.source] += 1;
          degreeMap[l.target] += 1;
        });
        const color = d3.scaleOrdinal()
          .domain(['root','other'])
          .range(['#1565c0', '#43a047']);
        const radiusScale = d3.scaleLinear()
          .domain([0, d3.max(Object.values(degreeMap)) || 1])
          .range([6, 20]);
        const simulation = d3.forceSimulation(nodes)
          .force('link', d3.forceLink(links).id(d => d.id).distance(80))
          .force('charge', d3.forceManyBody().strength(-160))
          .force('center', d3.forceCenter(width/2, height/2));
        const link = svg.append('g')
          .attr('stroke', '#999')
          .attr('stroke-opacity', 0.6)
          .selectAll('line')
          .data(links)
          .join('line')
          .attr('stroke-width', 1.5);
        const node = svg.append('g')
          .attr('stroke', '#fff')
          .attr('stroke-width', 1.5)
          .selectAll('circle')
          .data(nodes)
          .join('circle')
          .attr('r', d => radiusScale(degreeMap[d.id]))
          .attr('fill', d => color(d.id === '0' ? 'root' : 'other'))
          .call(d3.drag()
            .on('start', dragstarted)
            .on('drag', dragged)
            .on('end', dragended));
        node.append('title').text(d => d.id);
        simulation.on('tick', () => {
          link
            .attr('x1', d => d.source.x)
            .attr('y1', d => d.source.y)
            .attr('x2', d => d.target.x)
            .attr('y2', d => d.target.y);
          node
            .attr('cx', d => d.x)
            .attr('cy', d => d.y);
        });
        function dragstarted(event) {
          if (!event.active) simulation.alphaTarget(0.3).restart();
          event.subject.fx = event.subject.x;
          event.subject.fy = event.subject.y;
        }
        function dragged(event) {
          event.subject.fx = event.x;
          event.subject.fy = event.y;
        }
        function dragended(event) {
          if (!event.active) simulation.alphaTarget(0);
          event.subject.fx = null;
          event.subject.fy = null;
        }
      }
    </script>
</body>
</html>
